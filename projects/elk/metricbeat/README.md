# Metricbeat

## Install Metricbeat with dockerFile

```
ARG METRICBEAT_VERSION=7.4.1

RUN apt-get update && apt-get install -y wget && apt-get install -y gnupg \
    && wget -q -O /tmp/metricbeat.tar.gz https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-${METRICBEAT_VERSION}-linux-x86_64.tar.gz \
    && cd /tmp \
    && tar xzvf metricbeat.tar.gz \
    && cd metricbeat-* \
    && cp metricbeat /bin \
    && mkdir -p /etc/metricbeat \
    && cp metricbeat.yml /etc/metricbeat/metricbeat.yml \
    && rm -rf /tmp/metricbeat*
```

## Metricbeat General Configuration
To run Metricbeat, you should configure input (metrics sources like Docker), output (a remote service or database to send these metrics to), and various modules if needed. This configuration is located in the metricbeat.yml inside the Metricbeat folder

```
#========================== Modules configuration ========================
metricbeat.config.modules:
 # Glob pattern for configuration loading
 path: ${path.config}/modules.d/*.yml
 # Set to true to enable config reloading
 reload.enabled: false
 # Period on which files under path should be checked for changes
 reload.period: 10s
#==================== Elasticsearch template setting =====================
setup.template.settings:
 index.number_of_shards: 1
 index.codec: best_compression
 #_source.enabled: false
#============================== Dashboards ===============================
# These settings control loading the sample dashboards to the Kibana index. Loading
# the dashboards is disabled by default and can be enabled either by setting the
# options here, or by using the `-setup` CLI flag or the `setup` command.
setup.dashboards.enabled: true
#============================== Kibana ==================================
# Starting with Beats version 6.0.0, the dashboards are loaded via the Kibana API.
# This requires a Kibana endpoint configuration.
setup.kibana.host: "YOUR_KIBANA_HOST"
setup.kibana.protocol: "https"
setup.kibana.username: "YOUR_KIBANA_USERNAME"
setup.kibana.password: "YOUR_KIBANA_PASSWORD"
#================================ Outputs ================================
# Configure what output to use when sending the data collected by the beat.
#-------------------------- Elasticsearch output -------------------------
output.elasticsearch:
 hosts: ["YOUR_ELASTICSEARCH_HOST"]
 username: "YOUR_ELASTICSEARCH_USERNAME"
 password: "YOUR_ELASTICSEARCH_PASSWORD"
 # Optional protocol and basic auth credentials.
 #protocol: "https"
 #username: "elastic"
 #password: "changeme"
```
## Enable Docker Module
To fetch metrics from Docker containers, we are going to use Metricbeat Docker module. It comes with a number of default metricsets we need, such as container, cpu, diskio, healthcheck, info, memory, and network.

We can enable or disable any module configuration under modules.d by running modules enable or modules disable commands. For example:
```
metricbeat modules enable docker -c /etc/metricbeat/metricbeat.yml
```
Now, as the module is enabled, the yml will look like below:
```
- module: docker
 metricsets:
 - "container"
 - "cpu"
 - "diskio"
 - "healthcheck"
 - "info"
 - "image"
 - "memory"
 - "network"
 period: 10s
 enabled: true
```
By default, Docker listens on the Unix socket "unix:///var/run/docker.sock". We can use this socket to communicate with the daemon from within a container.Through this endpoint, Docker exposes the Docker API which can be used to get a stream of all events and statistics generated by Docker. So, under enabled docker module section, place the hosts like below:
```
- module: docker
 metricsets:
 - "container"
 - "cpu"
 - "diskio"
 - "healthcheck"
 - "info"
 - "image"
 - "memory"
 - "network"
 hosts: ["unix:///var/run/docker.sock"]
 period: 10s
 enabled: true
```
## Start service
start the metricbeat service in deployed container with command: "metricbeat -c /etc/metricbeat/metricbeat.yml -e"

## Check Index
If Elasticsearch is configured with metricbeat then almost immediately after being started, Metricbeat will begin sending Docker metrics to Elasticsearch index. You can verify this by curling your Elasticsearch host:

```
$ curl -XGET 'localhost:9200/_cat/indices?v&pretty'
health status index uuid pri rep docs.count docs.deleted store.size pri.store.size
yellow open metricbeat-6.3.2-2018.08.09 BikpOgqQR-pU_SuKrm5vw 1 1 2374 0 1.4mb 1.3mb
```
